
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FreeRoom | Global Glyph Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body {
      background: #000;
      color: #00FF00;
      font-family: monospace;
      margin: 0;
    }
    .header {
      color: red;
      text-align: center;
      font-size: 2rem;
      padding: 1rem;
    }
    .glyph-promo {
      text-align: center;
      margin-top: -0.5rem;
      margin-bottom: 0.5rem;
    }
    .glyph-promo a {
      color: #00ff88;
      text-decoration: none;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border: 1px solid #00ff88;
      border-radius: 8px;
      box-shadow: 0 0 8px #00ff88;
      animation: glow 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 0.9; }
    }
    .pulse {
      animation: pulse 0.8s ease-in-out;
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 8px #00ff88; }
      50% { box-shadow: 0 0 16px #00ff88; }
    }
    #terminal {
      height: 55vh;
      overflow-y: auto;
      padding: 1rem;
      border-top: 2px solid red;
      border-bottom: 2px solid red;
      max-width: 100vw;
      box-sizing: border-box;
    }
    .message {
      margin: 0.3rem 0;
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #chat-input {
      width: 100%;
      padding: 1rem;
      font-size: 1.1rem;
      background: #000;
      color: #0f0;
      border: none;
      box-sizing: border-box;
      max-width: 100vw;
    }
    .admin {
      text-align: center;
      margin-top: 1rem;
    }
    .admin button {
      background: #111;
      color: #f00;
      border: 1px solid red;
      padding: 0.4rem 1rem;
      cursor: pointer;
      font-family: monospace;
    }
    .admin button:hover {
      background: #300;
    }
  </style>
</head>
<body>
  <div class="header">
    FreeRoom â€“ Speak Without Fear<br>
    <span style="font-size: 1rem; color: #0f0;">ðŸ§¿ <span id="userCount" class="pulse">0</span> glyphs online</span>
  </div>

  <div class="glyph-promo">
    <a href="https://www.amazon.com/stores/author/B0D8ZDM779/allbooks?" target="_blank">
      ðŸœ‚ <span id="glyphText">Ederian (R)evolution</span>
    </a>
  </div>

  <div id="glyphLog" style="text-align:center; color:#0f0; font-size:0.9rem;"></div>
  <div id="dashboardLog" style="text-align:center; margin-top:0.3rem; color:#aaa; font-size:0.8rem;">
    ðŸŒ’ FreeRoom metrics updating...
  </div>

  <div id="terminal"></div>
  <input type="text" id="chat-input" placeholder="Type something...">

  <div class="admin">
    <button onclick="purgeOldMessages()">ðŸ§¹ Manual Purge</button>
    <span id="purgeStatus" style="color: #888; margin-left: 1rem;"></span>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAfepI6o8LUUkj5LKU9iXjZ9RQ274l",
      authDomain: "freeroom-397b7.firebaseapp.com",
      databaseURL: "https://freeroom-397b7-default-rtdb.firebaseio.com",
      projectId: "freeroom-397b7",
      storageBucket: "freeroom-397b7.appspot.com",
      messagingSenderId: "311136074671",
      appId: "1:311136074671:web:2ad59f5091692c73f08e8",
      measurementId: "G-J6K58KM0CE"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const terminal = document.getElementById('terminal');
    const input = document.getElementById('chat-input');
    const purgeStatus = document.getElementById('purgeStatus');

    const glyphs = [
      { name: "Ashur", icon: "â˜¥" }, { name: "Solareth", icon: "â˜€" },
      { name: "Vireon", icon: "âš¡" }, { name: "Nytheron", icon: "ðŸŒ™" },
      { name: "Tharion", icon: "âœ¦" }, { name: "Velthryn", icon: "âœª" },
      { name: "Kaon", icon: "âœ·" }, { name: "Zenthros", icon: "â˜¬" },
      { name: "Luminar", icon: "â˜¼" }, { name: "Vaelix", icon: "â‡" }
    ];
    const glyph = glyphs[Math.floor(Math.random() * glyphs.length)];
    const username = `${glyph.icon} ${glyph.name}`;
    const userId = username + '_' + Math.random().toString(36).substr(2, 5);

    const presenceRef = db.ref('presence');
    const userPresenceRef = presenceRef.child(userId);

    firebase.database().ref('.info/connected').on('value', function(snapshot) {
      if (snapshot.val()) {
        userPresenceRef.set(true);
        userPresenceRef.onDisconnect().remove();
        document.getElementById('dashboardLog').innerText = `ðŸœ‚ Connected at ${new Date().toLocaleString()}`;
      }
    });

    presenceRef.on('value', snap => {
      document.getElementById('userCount').classList.add('pulse');
      setTimeout(() => {
        document.getElementById('userCount').classList.remove('pulse');
      }, 800);
      document.getElementById('userCount').innerText = snap.numChildren();
      let log = '';
      snap.forEach(child => {
        log += child.key.split('_')[0] + ' ';
      });
      document.getElementById('glyphLog').innerText = log.trim();
    });

    function writeMessage(msg) {
      const now = Date.now();
      db.ref("messages").push({
        username,
        message: msg,
        timestamp: now
      });
    }

    function renderMessage(data) {
      const div = document.createElement('div');
      div.className = 'message';
      const time = new Date(data.timestamp).toLocaleTimeString();
      div.innerHTML = `<span style='color:red;'>${data.username}</span> <span style='color:grey;'>[${time}]</span>: ${data.message}`;
      terminal.appendChild(div);
      terminal.scrollTop = terminal.scrollHeight;
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const val = input.value.trim();
        if (val) {
          writeMessage(val);
          input.value = "";
        }
      }
    });

    db.ref("messages").on("child_added", snapshot => {
      const msg = snapshot.val();
      if (msg.timestamp > Date.now() - 7 * 24 * 60 * 60 * 1000) {
        renderMessage(msg);
      }
    });

    function purgeOldMessages() {
      const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000;
      db.ref("messages").once("value").then(snapshot => {
        const updates = {};
        let count = 0;
        snapshot.forEach(child => {
          if (child.val().timestamp <= cutoff) {
            updates[child.key] = null;
            count++;
          }
        });
        db.ref("messages").update(updates).then(() => {
          purgeStatus.innerText = `ðŸ§¹ ${count} messages purged manually.`;
        });
      });
    }
  </script>
</body>
</html>
